import{r,h as I,j as e,i as F,k as X,A as Z,u as ee,b as se,B as o,C as ae,c as p,R as M,a as g,M as d}from"./index-CjvveDhR.js";import{A as te}from"./LoadingAnimations-_zIpEffa.js";import{I as re}from"./InvoiceTemplate-BiMOFdTP.js";import{a as R,F as S}from"./Form-BX9NS_Qh.js";import{A as ne}from"./Alert-CNoVHXkI.js";import"./Table-32sEwHPQ.js";const G=r.forwardRef(({bsPrefix:t,bg:l="primary",pill:i=!1,text:c,className:h,as:N="span",...x},u)=>{const f=I(t,"badge");return e.jsx(N,{ref:u,...x,className:F(h,f,i&&"rounded-pill",c&&`text-${c}`,l&&`bg-${l}`)})});G.displayName="Badge";const b=r.forwardRef(({className:t,bsPrefix:l,as:i="span",...c},h)=>(l=I(l,"input-group-text"),e.jsx(i,{ref:h,className:F(t,l),...c})));b.displayName="InputGroupText";const le=t=>e.jsx(b,{children:e.jsx(R,{type:"checkbox",...t})}),ie=t=>e.jsx(b,{children:e.jsx(R,{type:"radio",...t})}),z=r.forwardRef(({bsPrefix:t,size:l,hasValidation:i,className:c,as:h="div",...N},x)=>{t=I(t,"input-group");const u=r.useMemo(()=>({}),[]);return e.jsx(X.Provider,{value:u,children:e.jsx(h,{ref:x,...N,className:F(c,t,l&&`${t}-${l}`,i&&"has-validation")})})});z.displayName="InputGroup";const ce=Object.assign(z,{Text:b,Radio:ie,Checkbox:le}),je=()=>{const{user:t,logout:l}=r.useContext(Z),i=ee(),[c,h]=r.useState([]),[N,x]=r.useState(!0),[u,f]=r.useState(null),[H,k]=r.useState(!1),[V,T]=r.useState(!1),[a,v]=r.useState(null),[j,O]=r.useState({}),[B,y]=r.useState(1),[w,_]=r.useState(""),[C,Q]=r.useState("");r.useEffect(()=>{if(!t||t.role!=="admin"){i("/administracion");return}A()},[t,i,B,w,C]);const A=async()=>{try{x(!0);const s=localStorage.getItem("token"),n=new URLSearchParams({page:B.toString(),limit:"12"});w&&n.append("search",w),C&&n.append("status",C);const m=await fetch(`${se.invoices}?${n}`,{headers:{Authorization:`Bearer ${s}`}});if(!m.ok){if(m.status===403){f("No tienes permisos para ver las facturas."),await l(),i("/administracion");return}throw new Error("Error al cargar las facturas.")}const $=await m.json();h($.invoices),O($.pagination)}catch(s){f(s.message)}finally{x(!1)}},U=s=>{v(s),k(!0)},D=()=>{k(!1),v(null)},Y=s=>{v(s),T(!0)},P=()=>{T(!1),v(null)},q=()=>{const s=document.getElementById("invoice-template-view"),n=window.open("","","left=0,top=0,width=800,height=900,toolbar=0,scrollbars=0,status=0");n.document.write(`
      <html>
        <head>
          <title>Factura ${a==null?void 0:a.invoiceNumber}</title>
          <style>
            body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
            .invoice-container { max-width: 100%; }
            @media print {
              body { margin: 0; padding: 0; }
              .no-print { display: none; }
            }
          </style>
        </head>
        <body onload="window.print(); window.close();">
          ${s.innerHTML}
        </body>
      </html>
    `),n.document.close()},J=s=>{var n,m;return{firstName:s.firstName||((n=s.fullName)==null?void 0:n.split(" ")[0])||"",lastName:s.lastName||((m=s.fullName)==null?void 0:m.split(" ").slice(1).join(" "))||"",companyName:s.companyName||"",streetAddress:s.streetAddress||s.fullAddress||"",city:s.city||"",region:s.region||"La Araucanía",postalCode:s.postalCode||"",phone:s.phone||"",email:s.email||"",orderNotes:s.orderNotes||""}},K=s=>{s.preventDefault(),y(1),A()},W=s=>{Q(s),y(1)},E=s=>new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP"}).format(s),L=s=>{const n={draft:"secondary",pending:"warning",paid:"success",cancelled:"danger"},m={draft:"Borrador",pending:"Pendiente",paid:"Pagada",cancelled:"Cancelada"};return e.jsx(G,{bg:n[s]||"secondary",children:m[s]||s})};return N&&c.length===0?e.jsx("div",{className:"loading-overlay",children:e.jsxs("div",{className:"loading-content",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Cargando facturas..."})]})}):u?e.jsx("div",{className:"error-state",children:e.jsxs("div",{className:"error-message",children:[e.jsx("h4",{children:"Error al cargar las facturas"}),e.jsx("p",{children:u}),e.jsx(o,{variant:"outline-danger",onClick:()=>window.location.reload(),children:"Reintentar"})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("section",{className:"invoice-list-section",children:[e.jsxs(ae,{fluid:!0,className:"px-2 px-md-3",children:[e.jsx("h2",{className:"text-center mb-4 text-uppercase fw-semibold text-white",children:"Gestión de Facturas"}),e.jsx(p,{className:"filters-card mb-4",children:e.jsx(p.Body,{children:e.jsxs(M,{className:"g-3",children:[e.jsx(g,{md:6,children:e.jsx(S,{onSubmit:K,children:e.jsxs(ce,{children:[e.jsx(S.Control,{type:"text",placeholder:"Buscar por nombre, empresa, email o número...",value:w,onChange:s=>_(s.target.value)}),e.jsx(o,{variant:"primary",type:"submit",children:"Buscar"})]})})}),e.jsx(g,{md:3,children:e.jsxs(S.Select,{value:C,onChange:s=>W(s.target.value),children:[e.jsx("option",{value:"",children:"Todos los estados"}),e.jsx("option",{value:"draft",children:"Borradores"}),e.jsx("option",{value:"pending",children:"Pendientes"}),e.jsx("option",{value:"paid",children:"Pagadas"}),e.jsx("option",{value:"cancelled",children:"Canceladas"})]})}),e.jsx(g,{md:3,children:e.jsx(o,{variant:"success",onClick:()=>i("/administracion/facturacion"),className:"w-100",children:"Nueva Factura"})})]})})}),e.jsx("div",{className:"invoice-stats-summary",children:e.jsxs("h4",{children:["Total Facturas: ",j.totalInvoices||0]})}),e.jsx(M,{xs:1,sm:2,lg:3,xl:4,className:"g-3 g-md-4",children:c.length>0?c.map((s,n)=>e.jsx(g,{className:"slide-up",style:{animationDelay:`${n*.1}s`},children:e.jsx(p,{className:"invoice-admin-card h-100 interactive-element",children:e.jsxs(p.Body,{className:"d-flex flex-column",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-2",children:[e.jsx(p.Title,{className:"fw-bold text-truncate",title:s.fullName,children:s.fullName}),L(s.status)]}),e.jsxs(p.Text,{className:"flex-grow-1",children:[e.jsx("strong",{children:"Número:"})," ",s.invoiceNumber,e.jsx("br",{}),e.jsx("strong",{children:"Email:"})," ",s.email,e.jsx("br",{}),s.companyName&&e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:"Empresa:"})," ",s.companyName,e.jsx("br",{})]}),e.jsx("strong",{children:"Total:"})," ",E(s.total),e.jsx("br",{}),e.jsx("small",{className:"text-muted",children:new Date(s.createdAt).toLocaleDateString()})]}),e.jsxs("div",{className:"d-flex gap-2 mt-auto",children:[e.jsx(o,{variant:"outline-primary",onClick:()=>U(s),className:"touch-feedback flex-fill",size:"sm",children:"Ver Detalles"}),e.jsx(o,{variant:"primary",onClick:()=>Y(s),className:"touch-feedback flex-fill",size:"sm",children:"Ver Factura"})]})]})})},s._id)):e.jsx(g,{xs:12,className:"fade-in",children:e.jsx(ne,{variant:"info",className:"text-center",children:"No hay facturas para mostrar."})})}),j.totalPages>1&&e.jsxs("div",{className:"pagination-controls text-center mt-4",children:[e.jsx(o,{variant:"outline-light",disabled:!j.hasPrev,onClick:()=>y(s=>s-1),className:"me-2",children:"Anterior"}),e.jsxs("span",{className:"text-white mx-3",children:["Página ",j.currentPage," de ",j.totalPages]}),e.jsx(o,{variant:"outline-light",disabled:!j.hasNext,onClick:()=>y(s=>s+1),className:"ms-2",children:"Siguiente"})]})]}),e.jsxs(d,{show:H,onHide:D,centered:!0,size:"lg",className:"invoice-detail-modal",children:[e.jsx(d.Header,{closeButton:!0,children:e.jsx(d.Title,{children:"Detalles de Factura"})}),e.jsx(d.Body,{children:a&&e.jsx("div",{className:"invoice-details",children:e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-sm-6",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Número de Factura:"}),e.jsx("span",{children:a.invoiceNumber})]})}),e.jsx("div",{className:"col-sm-6",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Estado:"}),e.jsx("span",{children:L(a.status)})]})}),e.jsx("div",{className:"col-sm-6",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Cliente:"}),e.jsx("span",{children:a.fullName})]})}),a.companyName&&e.jsx("div",{className:"col-sm-6",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Empresa:"}),e.jsx("span",{children:a.companyName})]})}),e.jsx("div",{className:"col-sm-6",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Teléfono:"}),e.jsx("span",{children:a.phone})]})}),e.jsx("div",{className:"col-sm-6",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Email:"}),e.jsx("span",{children:a.email})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Dirección:"}),e.jsx("span",{children:a.fullAddress})]})}),e.jsx("div",{className:"col-sm-6",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Total:"}),e.jsx("span",{children:E(a.total)})]})}),e.jsx("div",{className:"col-sm-6",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Fecha de Creación:"}),e.jsx("span",{children:new Date(a.createdAt).toLocaleString()})]})}),a.orderNotes&&e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Notas del pedido:"}),e.jsx("span",{children:a.orderNotes})]})}),a.createdBy&&e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Creada por:"}),e.jsx("span",{children:a.createdBy.username})]})})]})})}),e.jsx(d.Footer,{children:e.jsx(o,{variant:"secondary",onClick:D,children:"Cerrar"})})]}),e.jsxs(d,{show:V,onHide:P,centered:!0,size:"xl",className:"invoice-template-modal",backdrop:"static",children:[e.jsxs(d.Header,{children:[e.jsxs(d.Title,{children:["Factura ",a==null?void 0:a.invoiceNumber," - ",a==null?void 0:a.fullName]}),e.jsxs("div",{className:"d-flex gap-2 no-print",children:[e.jsx(o,{variant:"outline-primary",onClick:q,size:"sm",children:"Imprimir"}),e.jsx(o,{variant:"outline-secondary",onClick:P,size:"sm",children:"Cerrar"})]})]}),e.jsx(d.Body,{style:{padding:0,maxHeight:"80vh",overflowY:"auto"},children:a&&e.jsx("div",{id:"invoice-template-view",children:e.jsx(re,{formData:J(a),selectedQuote:null,invoiceNumber:a.invoiceNumber,currentDate:new Date(a.createdAt).toLocaleDateString("es-CL"),isViewMode:!0})})})]})]}),e.jsx(te,{user:t,onLogout:l})]})};export{je as default};
