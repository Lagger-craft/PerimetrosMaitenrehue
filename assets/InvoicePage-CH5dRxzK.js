import{r as i,A as W,u as X,f as Z,j as e,C as q,R as j,a as m,c as d,B as t,M as l,b as D}from"./index-CjvveDhR.js";import{A as ee}from"./LoadingAnimations-_zIpEffa.js";import{I as ae}from"./InvoiceTemplate-BiMOFdTP.js";import{A as B}from"./Alert-CNoVHXkI.js";import{F as s}from"./Form-BX9NS_Qh.js";import"./Table-32sEwHPQ.js";const se=["Angol","Renaico","Collipulli","Ercilla","Los Sauces","Purén","Lumaco","Traiguén","Galvarino","Lautaro","Perquenco","Victoria","Curacautín","Lonquimay","Temuco","Padre Las Casas","Freire","Pitrufquén","Gorbea","Loncoche","Villarrica","Pucón","Curarrehue"],ce=()=>{const{user:N,logout:M}=i.useContext(W),g=X(),f=Z(),[n,v]=i.useState({firstName:"",lastName:"",companyName:"",country:"Chile",streetAddress:"",city:"",region:"La Araucanía",postalCode:"",phone:"",email:"",orderNotes:""}),[Q,L]=i.useState(!1),[A,u]=i.useState(null),[I,y]=i.useState(null),[h,P]=i.useState(!1),[V,b]=i.useState(!1),[$,x]=i.useState(!1),[T,H]=i.useState([]),[R,p]=i.useState(!1),[O,z]=i.useState(!1),[C,F]=i.useState(null),[w,E]=i.useState(null);i.useEffect(()=>{var a;(a=f.state)!=null&&a.selectedQuote&&(S(f.state.selectedQuote),window.history.replaceState({},document.title))},[f.state]);const o=a=>{const{name:r,value:c}=a.target;v(k=>({...k,[r]:c}))},_=async()=>{try{z(!0);const a=localStorage.getItem("token"),r=await fetch(D.quotes,{headers:{Authorization:`Bearer ${a}`}});if(!r.ok)throw new Error("Error al cargar las cotizaciones");const c=await r.json();H(c)}catch(a){u("Error al cargar cotizaciones: "+a.message)}finally{z(!1)}},S=a=>{const r=a.name.trim().split(" "),c=r[0]||"",k=r.slice(1).join(" ")||"";v({firstName:c,lastName:k,companyName:"",country:"Chile",streetAddress:a.address||"",city:"",region:"La Araucanía",postalCode:"",phone:a.phone||"",email:a.email||"",orderNotes:`Cotización original:
      - Altura del cerco: ${a.fenceHeight}
      - Tipo: ${a.fenceType}
      - Metros lineales: ${a.linearMeters}
      ${a.message?`- Mensaje: ${a.message}`:""}`}),F(a),p(!1),y(`Datos cargados desde la cotización de ${a.name}`)},J=async()=>{p(!0),await _()},U=async a=>{const r=a.currentTarget;if(a.preventDefault(),a.stopPropagation(),r.checkValidity()===!1){L(!0),u("Por favor, completa todos los campos obligatorios.");return}L(!1),x(!0)},G=async()=>{P(!0),u(null),y(null);try{const a=localStorage.getItem("token"),r=await fetch(D.invoices,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(n)}),c=await r.json();if(!r.ok)throw new Error(c.message||"Error al generar la factura");y(`¡Factura generada exitosamente! Número: ${c.invoice.invoiceNumber}`),E(c.invoice),b(!1),v({firstName:"",lastName:"",companyName:"",country:"Chile",streetAddress:"",city:"",region:"La Araucanía",postalCode:"",phone:"",email:"",orderNotes:""}),F(null),setTimeout(()=>{x(!0)},2e3)}catch(a){console.error("Error creating invoice:",a),u(a.message||"Error al generar la factura. Inténtalo nuevamente.")}finally{P(!1)}},Y=()=>{const a=document.getElementById("invoice-template"),r=window.open("","","left=0,top=0,width=800,height=900,toolbar=0,scrollbars=0,status=0");r.document.write(`
      <html>
        <head>
          <title>Cotización</title>
          <style>
            body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
            .invoice-container { max-width: 100%; }
            @media print {
              body { margin: 0; padding: 0; }
              .no-print { display: none; }
            }
          </style>
        </head>
        <body onload="window.print(); window.close();">
          ${a.innerHTML}
        </body>
      </html>
    `),r.document.close()},K=()=>{x(!1),E(null)};return!N||N.role!=="admin"?(g("/administracion"),null):e.jsxs(e.Fragment,{children:[e.jsxs("section",{className:"invoice-page-section",children:[e.jsxs(q,{fluid:!0,className:"px-2 px-md-3",children:[e.jsx("h2",{className:"text-center mb-4 text-uppercase fw-semibold text-white",children:"Generar Factura"}),e.jsx(j,{className:"justify-content-center",children:e.jsx(m,{xs:12,lg:8,xl:6,children:e.jsx(d,{className:"invoice-card",children:e.jsxs(d.Body,{children:[e.jsx(d.Title,{className:"mb-4",children:"Detalles de Facturación"}),e.jsxs("div",{className:"mb-3",children:[e.jsx(t,{variant:"outline-primary",onClick:J,className:"w-100",children:"📋 Cargar datos desde cotización existente"}),C&&e.jsxs("small",{className:"text-muted d-block mt-1",children:["Datos cargados desde cotización de: ",C.name]})]}),I&&e.jsx(B,{variant:"success",children:I}),A&&e.jsx(B,{variant:"danger",children:A}),e.jsxs(s,{noValidate:!0,validated:Q,onSubmit:U,children:[e.jsxs(j,{className:"g-3",children:[e.jsx(m,{md:6,children:e.jsxs(s.Group,{controlId:"firstName",children:[e.jsx(s.Label,{children:"Nombre *"}),e.jsx(s.Control,{type:"text",name:"firstName",value:n.firstName,onChange:o,required:!0,className:"mobile-friendly-input"}),e.jsx(s.Control.Feedback,{type:"invalid",children:"Por favor ingresa el nombre."})]})}),e.jsx(m,{md:6,children:e.jsxs(s.Group,{controlId:"lastName",children:[e.jsx(s.Label,{children:"Apellido *"}),e.jsx(s.Control,{type:"text",name:"lastName",value:n.lastName,onChange:o,required:!0,className:"mobile-friendly-input"}),e.jsx(s.Control.Feedback,{type:"invalid",children:"Por favor ingresa el apellido."})]})})]}),e.jsxs(s.Group,{className:"mb-3",controlId:"companyName",children:[e.jsx(s.Label,{children:"Nombre de la Empresa (opcional)"}),e.jsx(s.Control,{type:"text",name:"companyName",value:n.companyName,onChange:o,className:"mobile-friendly-input"})]}),e.jsxs(s.Group,{className:"mb-3",controlId:"country",children:[e.jsx(s.Label,{children:"País/Región *"}),e.jsx(s.Control,{type:"text",name:"country",value:n.country,readOnly:!0,className:"mobile-friendly-input",style:{backgroundColor:"#f8f9fa"}})]}),e.jsxs(s.Group,{className:"mb-3",controlId:"streetAddress",children:[e.jsx(s.Label,{children:"Dirección de la calle *"}),e.jsx(s.Control,{type:"text",name:"streetAddress",value:n.streetAddress,onChange:o,required:!0,className:"mobile-friendly-input",placeholder:"Calle, número, departamento, etc."}),e.jsx(s.Control.Feedback,{type:"invalid",children:"Por favor ingresa la dirección."})]}),e.jsxs(j,{className:"g-3",children:[e.jsx(m,{md:6,children:e.jsxs(s.Group,{controlId:"city",children:[e.jsx(s.Label,{children:"Comuna *"}),e.jsxs(s.Select,{name:"city",value:n.city,onChange:o,required:!0,className:"mobile-friendly-input",children:[e.jsx("option",{value:"",children:"Selecciona una comuna"}),se.map(a=>e.jsx("option",{value:a,children:a},a))]}),e.jsx(s.Control.Feedback,{type:"invalid",children:"Por favor selecciona la comuna."})]})}),e.jsx(m,{md:6,children:e.jsxs(s.Group,{controlId:"region",children:[e.jsx(s.Label,{children:"Región"}),e.jsx(s.Control,{type:"text",name:"region",value:n.region,readOnly:!0,className:"mobile-friendly-input",style:{backgroundColor:"#f8f9fa"}}),e.jsx(s.Text,{className:"text-muted",children:"Servicio disponible solo en La Araucanía (80km de Angol)"})]})})]}),e.jsxs(s.Group,{className:"mb-3",controlId:"postalCode",children:[e.jsx(s.Label,{children:"Código postal (opcional)"}),e.jsx(s.Control,{type:"text",name:"postalCode",value:n.postalCode,onChange:o,className:"mobile-friendly-input"})]}),e.jsxs(j,{className:"g-3",children:[e.jsx(m,{md:6,children:e.jsxs(s.Group,{controlId:"phone",children:[e.jsx(s.Label,{children:"Teléfono *"}),e.jsx(s.Control,{type:"tel",name:"phone",value:n.phone,onChange:o,required:!0,className:"mobile-friendly-input"}),e.jsx(s.Control.Feedback,{type:"invalid",children:"Por favor ingresa el teléfono."})]})}),e.jsx(m,{md:6,children:e.jsxs(s.Group,{controlId:"email",children:[e.jsx(s.Label,{children:"Dirección de correo electrónico *"}),e.jsx(s.Control,{type:"email",name:"email",value:n.email,onChange:o,required:!0,className:"mobile-friendly-input"}),e.jsx(s.Control.Feedback,{type:"invalid",children:"Por favor ingresa un email válido."})]})})]}),e.jsxs(s.Group,{className:"mb-4",controlId:"orderNotes",children:[e.jsx(s.Label,{children:"Información adicional: Notas del pedido (opcional)"}),e.jsx(s.Control,{as:"textarea",rows:4,name:"orderNotes",value:n.orderNotes,onChange:o,className:"mobile-friendly-input",placeholder:"Notas sobre el pedido, instrucciones especiales, etc."})]}),e.jsxs("div",{className:"d-grid gap-2 d-md-flex justify-content-md-end",children:[e.jsx(t,{variant:"outline-secondary",onClick:()=>g("/administracion/dashboard"),className:"me-md-2",children:"Cancelar"}),e.jsx(t,{variant:"primary",type:"submit",className:"touch-feedback",children:"Vista Previa de Cotización"})]})]})]})})})})]}),e.jsxs(l,{show:V,onHide:()=>b(!1),centered:!0,size:"lg",className:"invoice-preview-modal",children:[e.jsx(l.Header,{closeButton:!0,children:e.jsx(l.Title,{children:"Confirmar Factura"})}),e.jsx(l.Body,{children:e.jsxs("div",{className:"invoice-preview",children:[e.jsx("h5",{className:"mb-3",children:"Resumen de Facturación"}),e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-sm-6",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Cliente:"}),e.jsxs("span",{children:[n.firstName," ",n.lastName]})]})}),n.companyName&&e.jsx("div",{className:"col-sm-6",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Empresa:"}),e.jsx("span",{children:n.companyName})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Dirección:"}),e.jsxs("span",{children:[n.streetAddress,", ",n.city,", ",n.region,n.postalCode&&`, ${n.postalCode}`]})]})}),e.jsx("div",{className:"col-sm-6",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Teléfono:"}),e.jsx("span",{children:n.phone})]})}),e.jsx("div",{className:"col-sm-6",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Email:"}),e.jsx("span",{children:n.email})]})}),n.orderNotes&&e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Notas del pedido:"}),e.jsx("span",{children:n.orderNotes})]})})]})]})}),e.jsxs(l.Footer,{children:[e.jsx(t,{variant:"secondary",onClick:()=>b(!1),disabled:h,children:"Editar"}),e.jsx(t,{variant:"primary",onClick:G,disabled:h,className:"touch-feedback",children:h?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Generando..."]}):"Confirmar Factura"})]})]}),e.jsxs(l,{show:R,onHide:()=>p(!1),centered:!0,size:"lg",className:"quotes-selection-modal",children:[e.jsx(l.Header,{closeButton:!0,children:e.jsx(l.Title,{children:"Seleccionar Cotización"})}),e.jsx(l.Body,{children:O?e.jsxs("div",{className:"text-center p-4",children:[e.jsx("div",{className:"spinner-border",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Cargando cotizaciones..."})}),e.jsx("p",{className:"mt-2",children:"Cargando cotizaciones..."})]}):T.length>0?e.jsxs("div",{className:"quotes-list",children:[e.jsx("p",{className:"text-muted mb-3",children:"Selecciona una cotización para autocompletar los datos de la factura:"}),e.jsx("div",{className:"row g-3",children:T.map(a=>e.jsx("div",{className:"col-12",children:e.jsx(d,{className:"quote-selection-card h-100",style:{cursor:"pointer"},onClick:()=>S(a),children:e.jsx(d.Body,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsx(d.Title,{className:"h6 mb-2",children:a.name}),e.jsxs(d.Text,{className:"small mb-1",children:[e.jsx("strong",{children:"Email:"})," ",a.email,e.jsx("br",{}),e.jsx("strong",{children:"Teléfono:"})," ",a.phone,e.jsx("br",{}),e.jsx("strong",{children:"Dirección:"})," ",a.address]}),e.jsxs(d.Text,{className:"small text-muted",children:[e.jsx("strong",{children:"Cerco:"})," ",a.fenceHeight," - ",a.linearMeters,"m",e.jsx("br",{}),e.jsx("strong",{children:"Fecha:"})," ",new Date(a.timestamp).toLocaleDateString()]})]}),e.jsx(t,{variant:"primary",size:"sm",onClick:r=>{r.stopPropagation(),S(a)},children:"Seleccionar"})]})})})},a._id))})]}):e.jsxs("div",{className:"text-center p-4",children:[e.jsx("p",{className:"text-muted",children:"No hay cotizaciones disponibles."}),e.jsx(t,{variant:"outline-primary",onClick:()=>g("/administracion/dashboard"),children:"Ver Dashboard"})]})}),e.jsx(l.Footer,{children:e.jsx(t,{variant:"secondary",onClick:()=>p(!1),children:"Cancelar"})})]})]}),e.jsxs(l,{show:$,onHide:()=>x(!1),centered:!0,size:"xl",className:"invoice-template-modal",backdrop:"static",children:[e.jsxs(l.Header,{children:[e.jsx(l.Title,{children:"Vista Previa de Cotización"}),e.jsxs("div",{className:"d-flex gap-2 no-print",children:[e.jsx(t,{variant:"success",onClick:G,disabled:h,size:"sm",children:h?"Generando...":"Confirmar y Generar"}),e.jsx(t,{variant:"outline-primary",onClick:Y,size:"sm",children:"Imprimir"}),e.jsx(t,{variant:"outline-secondary",onClick:K,size:"sm",children:"Volver al Formulario"})]})]}),e.jsx(l.Body,{style:{padding:0,maxHeight:"80vh",overflowY:"auto"},children:e.jsx(ae,{formData:n,selectedQuote:C,invoiceNumber:(w==null?void 0:w.invoiceNumber)||"PREV-"+Date.now(),currentDate:new Date().toLocaleDateString("es-CL")})})]}),e.jsx(ee,{user:N,onLogout:M})]})};export{ce as default};
